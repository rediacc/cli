name: "SCHEDULES_TEST"
description: "Test schedule creation, update, and deletion"
executor: "rediacc-cli.py"

# Import team name from previous test file
chain_import:
  - "test_team_name"

# Export schedule name for use in subsequent tests
chain_export:
  test_schedule_name: "${config.test_data.schedule.name_pattern}"

tests:
  - name: "create_backup_schedule"
    command: ["CreateSchedule"]
    args:
      teamName: "${chain.test_team_name}"
      scheduleName: "${config.test_data.schedule.name_pattern}"
      scheduleVault: "{\"CRON\": \"0 2 * * *\", \"FUNCTION\": \"backup\", \"TARGET_REPOSITORY\": \"main-app\", \"STORAGE\": \"s3-backup\", \"ENABLED\": \"true\"}"
    expect:
      success: true
  
  - name: "create_cleanup_schedule"
    command: ["CreateSchedule"]
    args:
      teamName: "${chain.test_team_name}"
      scheduleName: "${config.test_data.schedule.name_pattern}-cleanup"
      scheduleVault: "{\"CRON\": \"0 4 * * 0\", \"FUNCTION\": \"cleanup\", \"RETENTION_DAYS\": \"30\", \"ENABLED\": \"false\"}"
    expect:
      success: true
  
  - name: "list_team_schedules"
    command: ["GetTeamSchedules"]
    args:
      teamName: "${chain.test_team_name}"
    expect:
      success: true
      output_contains:
        - "${config.test_data.schedule.name_pattern}"
        - "${config.test_data.schedule.name_pattern}-cleanup"
  
  - name: "update_schedule_name"
    command: ["UpdateScheduleName"]
    args:
      teamName: "${chain.test_team_name}"
      currentScheduleName: "${config.test_data.schedule.name_pattern}"
      newScheduleName: "Updated-${config.test_data.schedule.name_pattern}"
    expect:
      success: true
  
  # Note: update schedule-vault command might return "Unsupported resource type" error
  # This might be a plan limitation or backend issue
  # - name: "update_schedule_vault"
  #   command: ["update", "schedule-vault", "${chain.test_team_name}", "Updated-${config.test_data.schedule.name_pattern}"]
  #   args:
  #     vault: "{\"CRON\": \"0 3 * * *\", \"FUNCTION\": \"backup\", \"TARGET_REPOSITORY\": \"main-app\", \"STORAGE\": \"s3-backup\", \"ENABLED\": \"true\", \"NOTIFICATION_EMAIL\": \"admin@example.com\"}"
  #   expect:
  #     success: true
  
  # - name: "enable_cleanup_schedule"
  #   command: ["update", "schedule-vault", "${chain.test_team_name}", "${config.test_data.schedule.name_pattern}-cleanup"]
  #   args:
  #     vault: "{\"CRON\": \"0 4 * * 0\", \"FUNCTION\": \"cleanup\", \"RETENTION_DAYS\": \"30\", \"ENABLED\": \"true\"}"
  #   expect:
  #     success: true
  
  - name: "delete_cleanup_schedule"
    command: ["DeleteSchedule"]
    args:
      teamName: "${chain.test_team_name}"
      scheduleName: "${config.test_data.schedule.name_pattern}-cleanup"
    expect:
      success: true
  
  - name: "delete_backup_schedule"
    command: ["DeleteSchedule"]
    args:
      teamName: "${chain.test_team_name}"
      scheduleName: "Updated-${config.test_data.schedule.name_pattern}"
    expect:
      success: true