<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rediacc Protocol Testing Suite - Dynamic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            margin: 20px 0;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .connection-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 10px;
        }

        .connected {
            background: #d4edda;
            color: #155724;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            background: #fff3cd;
            color: #856404;
        }

        .credentials-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .test-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .test-link {
            display: block;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            text-decoration: none;
            color: #495057;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .test-link:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .test-link h3 {
            color: #343a40;
            margin-bottom: 8px;
        }

        .test-link p {
            font-size: 0.9em;
            color: #6c757d;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .form-group {
            flex: 1;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }

        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        button:hover {
            background: #5a6fd8;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .generated-url {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #2196f3;
            margin: 15px 0;
            word-break: break-all;
        }

        .log-section {
            background: #212529;
            color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .log-time {
            color: #6c757d;
            font-size: 11px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-green { background: #28a745; }
        .status-red { background: #dc3545; }
        .status-yellow { background: #ffc107; }

        .api-test {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .refresh-btn {
            background: #28a745;
            font-size: 12px;
            padding: 5px 10px;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }

            .test-links {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîó Rediacc Protocol Testing Suite</h1>
        <p>Dynamic testing with real Rediacc credentials and CLI integration</p>
        <div id="connection-status" class="connection-status loading">
            <span class="status-indicator status-yellow"></span>
            Connecting to Protocol Test Server...
        </div>
    </div>

    <div class="section">
        <h2>üìä System Status</h2>
        <div id="credentials-info" class="credentials-info">
            <p>Loading credentials and system information...</p>
        </div>

        <div class="api-test">
            <h3>üîå API Connectivity Tests</h3>
            <button onclick="testAPIEndpoints()">Test All Endpoints</button>
            <button onclick="refreshData()" class="refresh-btn">üîÑ Refresh Data</button>
            <div id="api-results" style="margin-top: 10px;"></div>
        </div>
    </div>

    <div class="section">
        <h2>üìã Dynamic Test Links</h2>
        <p>These links use real data from your Rediacc system:</p>
        <div class="test-links" id="dynamic-test-links">
            <div>Loading test links...</div>
        </div>
    </div>

    <div class="section">
        <h2>üõ†Ô∏è Custom URL Generator</h2>
        <div class="controls">
            <div class="form-row">
                <div class="form-group">
                    <label for="token">Token:</label>
                    <input type="text" id="token" placeholder="Loading...">
                </div>
                <div class="form-group">
                    <label for="team">Team:</label>
                    <select id="team" onchange="loadMachines()">
                        <option value="">Loading teams...</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="machine">Machine:</label>
                    <select id="machine" onchange="loadRepositories()">
                        <option value="">Select team first</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="repository">Repository:</label>
                    <select id="repository">
                        <option value="">Select machine first</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="action">Action:</label>
                    <select id="action" onchange="updateActionParams()">
                        <option value="">Basic connection</option>
                        <option value="sync">File Sync</option>
                        <option value="terminal">Terminal</option>
                        <option value="plugin">Plugin</option>
                        <option value="browser">Browser</option>
                    </select>
                </div>
            </div>

            <div id="action-params"></div>

            <button onclick="generateURL()">üîó Generate Protocol URL</button>
            <button onclick="testURL()">üß™ Test URL</button>
        </div>

        <div id="generated-url" class="generated-url" style="display: none;">
            <strong>Generated URL:</strong><br>
            <span id="url-display"></span><br>
            <button onclick="copyURL()">üìã Copy</button>
            <button onclick="openURL()">üöÄ Open</button>
        </div>
    </div>

    <div class="section">
        <h2>üìú Live Protocol Testing Log</h2>
        <div id="log" class="log-section">
            <div class="log-entry">
                <span class="log-time">[Loading]</span> Initializing protocol test environment...
            </div>
        </div>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        <button onclick="exportResults()">üíæ Export Results</button>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            apiBaseUrl: 'http://localhost:8765/api',
            serverConnected: false,
            credentials: null,
            teams: [],
            machines: {},
            repositories: {}
        };

        let testResults = [];

        // Initialize the page
        async function init() {
            log('üöÄ Initializing dynamic protocol testing environment...');

            // Test server connection
            await testServerConnection();

            if (CONFIG.serverConnected) {
                await loadCredentials();
                await loadTeams();
                // Load machines for the first team, then generate test links
                if (CONFIG.teams.length > 0) {
                    await loadMachines(CONFIG.teams[0].name);
                    // loadRepositories will be called automatically by loadMachines when first machine is selected
                }
                generateDynamicTestLinks();
            } else {
                log('‚ùå Cannot connect to protocol test server. Please start the server with:');
                log('   python3 tests/protocol/protocol_test_server.py');
                showServerStartInstructions();
            }
        }

        async function testServerConnection() {
            try {
                const response = await fetch(`${CONFIG.apiBaseUrl.replace('/api', '')}/health`);
                const data = await response.json();

                if (data.status === 'healthy') {
                    CONFIG.serverConnected = true;
                    updateConnectionStatus('connected', 'Connected to Protocol Test Server');
                    log('‚úÖ Successfully connected to protocol test server');
                } else {
                    throw new Error('Server health check failed');
                }
            } catch (error) {
                CONFIG.serverConnected = false;
                updateConnectionStatus('disconnected', 'Protocol Test Server Offline');
                log(`‚ùå Server connection failed: ${error.message}`);
            }
        }

        async function loadCredentials() {
            try {
                const response = await fetch(`${CONFIG.apiBaseUrl}/credentials`);
                const data = await response.json();

                CONFIG.credentials = data;
                document.getElementById('token').value = data.token || '';

                const credentialsInfo = document.getElementById('credentials-info');
                credentialsInfo.innerHTML = `
                    <div><strong>Email:</strong> ${data.email || 'Not configured'}</div>
                    <div><strong>Token:</strong> ${data.token ? '‚úÖ Configured' : '‚ùå Missing'}</div>
                    <div><strong>API URL:</strong> ${data.api_url}</div>
                    <div><strong>Last Updated:</strong> ${data.token_updated_at || 'Unknown'}</div>
                `;

                log(`üìß Loaded credentials for: ${data.email || 'Unknown user'}`);
            } catch (error) {
                log(`‚ùå Failed to load credentials: ${error.message}`);
            }
        }

        async function loadTeams() {
            try {
                const response = await fetch(`${CONFIG.apiBaseUrl}/teams`);
                const data = await response.json();

                CONFIG.teams = data.teams || [];

                const teamSelect = document.getElementById('team');
                teamSelect.innerHTML = '<option value="">Select a team</option>';

                CONFIG.teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.name;
                    option.textContent = `${team.name} (${team.machineCount} machines, ${team.repoCount} repos)`;
                    teamSelect.appendChild(option);
                });

                // Auto-select first team if available
                if (CONFIG.teams.length > 0) {
                    teamSelect.value = CONFIG.teams[0].name;
                    await loadMachines();
                }

                log(`üìÅ Loaded ${CONFIG.teams.length} teams`);
            } catch (error) {
                log(`‚ùå Failed to load teams: ${error.message}`);
            }
        }

        async function loadMachines(teamName = null) {
            if (!teamName) {
                teamName = document.getElementById('team').value;
            }
            if (!teamName) return;

            try {
                const response = await fetch(`${CONFIG.apiBaseUrl}/machines/${encodeURIComponent(teamName)}`);
                const data = await response.json();

                CONFIG.machines[teamName] = data.machines || [];

                const machineSelect = document.getElementById('machine');
                machineSelect.innerHTML = '<option value="">Select a machine</option>';

                CONFIG.machines[teamName].forEach(machine => {
                    const option = document.createElement('option');
                    option.value = machine.name;
                    option.textContent = `${machine.name} (${machine.ip})`;
                    machineSelect.appendChild(option);
                });

                // Auto-select first machine if available
                if (CONFIG.machines[teamName].length > 0) {
                    machineSelect.value = CONFIG.machines[teamName][0].name;
                    await loadRepositories(teamName, CONFIG.machines[teamName][0].name);
                }

                log(`üñ•Ô∏è Loaded ${CONFIG.machines[teamName].length} machines for ${teamName}`);
            } catch (error) {
                log(`‚ùå Failed to load machines: ${error.message}`);
            }
        }

        async function loadRepositories(teamName = null, machineName = null) {
            if (!teamName) {
                teamName = document.getElementById('team').value;
            }
            if (!machineName) {
                machineName = document.getElementById('machine').value;
            }

            const repoSelect = document.getElementById('repository');

            // Reset repository dropdown
            repoSelect.innerHTML = '<option value="">Select machine first</option>';

            if (!teamName || !machineName) {
                log(`‚ö†Ô∏è Need both team and machine to load repositories`);
                return;
            }

            try {
                const response = await fetch(`${CONFIG.apiBaseUrl}/repositories/${encodeURIComponent(teamName)}?machine=${encodeURIComponent(machineName)}`);
                const data = await response.json();

                const repositoryKey = `${teamName}_${machineName}`;
                CONFIG.repositories[repositoryKey] = data.repositories || [];

                repoSelect.innerHTML = '<option value="">Select a repository</option>';

                CONFIG.repositories[repositoryKey].forEach(repo => {
                    const option = document.createElement('option');
                    option.value = repo.name;
                    option.textContent = `${repo.name} (${repo.size}, ${repo.mounted ? 'mounted' : 'unmounted'})`;
                    repoSelect.appendChild(option);
                });

                // Auto-select first repository if available
                if (CONFIG.repositories[repositoryKey].length > 0) {
                    repoSelect.value = CONFIG.repositories[repositoryKey][0].name;
                }

                log(`üì¶ Loaded ${CONFIG.repositories[repositoryKey].length} repositories for machine ${machineName} in team ${teamName}`);
            } catch (error) {
                log(`‚ùå Failed to load repositories: ${error.message}`);
                repoSelect.innerHTML = '<option value="">Error loading repositories</option>';
            }
        }

        function generateDynamicTestLinks() {
            if (!CONFIG.credentials || !CONFIG.teams.length) {
                document.getElementById('dynamic-test-links').innerHTML = '<div>No data available - check server connection</div>';
                return;
            }

            const token = CONFIG.credentials.token;
            const team = CONFIG.teams[0]?.name || 'TestTeam';
            const machinesList = CONFIG.machines[team] || [];
            const machine = machinesList[0]?.name;

            // Get repositories for the selected machine
            const repositoryKey = machine ? `${team}_${machine}` : null;
            const repositoriesList = repositoryKey ? (CONFIG.repositories[repositoryKey] || []) : [];

            // Use real machines/repositories if available, otherwise show informative message
            const repository = repositoriesList[0]?.name;

            if (!machine || !repository) {
                document.getElementById('dynamic-test-links').innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 5px;">
                        <h3>‚ö†Ô∏è Missing System Data</h3>
                        <p><strong>Team:</strong> ${team} ‚úÖ</p>
                        <p><strong>Machines:</strong> ${machinesList.length} found ${machinesList.length === 0 ? '‚ùå' : '‚úÖ'}</p>
                        <p><strong>Repositories:</strong> ${repositoriesList.length} found ${repositoriesList.length === 0 ? '‚ùå' : '‚úÖ'}</p>
                        ${!machine ? '<p>Please create a machine in your team to test protocol links.</p>' : ''}
                        ${!repository ? '<p>Please create a repository to test protocol links.</p>' : ''}
                    </div>
                `;
                return;
            }

            const testScenarios = [
                {
                    title: "üîó Basic Connection Test",
                    url: `rediacc://${token}/${team}/${machine}/${repository}`,
                    description: "Test basic protocol registration with real credentials"
                },
                {
                    title: "üì§ Sync Upload Test",
                    url: `rediacc://${token}/${team}/${machine}/${repository}/sync?direction=upload&localPath=./upload&mirror=true`,
                    description: "Test file upload synchronization with mirror mode"
                },
                {
                    title: "üì• Sync Download Test",
                    url: `rediacc://${token}/${team}/${machine}/${repository}/sync?direction=download&localPath=./download&verify=true`,
                    description: "Test file download synchronization with verification"
                },
                {
                    title: "üíª Repository Terminal",
                    url: `rediacc://${token}/${team}/${machine}/${repository}/terminal`,
                    description: "Open terminal in repository environment"
                },
                {
                    title: "‚ö° Terminal with Command",
                    url: `rediacc://${token}/${team}/${machine}/${repository}/terminal?command=ls%20-la&autoExecute=true`,
                    description: "Execute specific command in terminal"
                },
                {
                    title: "üåê Browser Plugin",
                    url: `rediacc://${token}/${team}/${machine}/${repository}/plugin?type=browser&port=8080`,
                    description: "Launch browser plugin on port 8080"
                }
            ];

            const linksContainer = document.getElementById('dynamic-test-links');
            linksContainer.innerHTML = '';

            testScenarios.forEach((scenario, index) => {
                const linkElement = document.createElement('a');
                linkElement.href = scenario.url;
                linkElement.className = 'test-link';
                linkElement.onclick = (e) => {
                    e.preventDefault();
                    testProtocolURL(scenario.url, scenario.title);
                };

                linkElement.innerHTML = `
                    <h3>${scenario.title}</h3>
                    <p>${scenario.description}</p>
                    <code style="font-size: 0.8em; color: #6c757d;">${scenario.url}</code>
                `;

                linksContainer.appendChild(linkElement);
            });

            log(`üîó Generated ${testScenarios.length} dynamic test links using real data:`);
            log(`   Team: ${team}`);
            log(`   Machine: ${machine} (from ${machinesList.length} available)`);
            log(`   Repository: ${repository} (from ${repositoriesList.length} available)`);
        }

        async function testProtocolURL(url, title = 'Protocol Test') {
            log(`üß™ Testing protocol URL: ${title}`);
            log(`üîó URL: ${url}`);

            try {
                const response = await fetch(`${CONFIG.apiBaseUrl}/protocol/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });

                const result = await response.json();

                if (response.ok) {
                    log(`‚úÖ Protocol test successful:`);
                    log(`   Parsed: ${JSON.stringify(result.parsed, null, 2)}`);
                    log(`   CLI Command: ${result.simulation.would_execute}`);

                    if (result.cli_test) {
                        log(`   CLI Test: ${result.cli_test.success ? '‚úÖ' : '‚ùå'} ${result.cli_test.command}`);
                    }

                    // Try to actually invoke the protocol
                    window.open(url, '_self');
                } else {
                    log(`‚ùå Protocol test failed: ${result.error}`);
                }

                testResults.push({
                    url: url,
                    title: title,
                    timestamp: Date.now(),
                    result: result,
                    success: response.ok
                });

            } catch (error) {
                log(`‚ùå Protocol test error: ${error.message}`);
            }
        }

        function generateURL() {
            const token = document.getElementById('token').value;
            const team = document.getElementById('team').value;
            const machine = document.getElementById('machine').value;
            const repository = document.getElementById('repository').value;
            const action = document.getElementById('action').value;

            if (!token || !team || !machine || !repository) {
                alert('Please fill in all required fields');
                return;
            }

            let url = `rediacc://${token}/${team}/${machine}/${repository}`;

            if (action) {
                url += `/${action}`;

                // Add action-specific parameters
                const params = new URLSearchParams();
                const actionParamsDiv = document.getElementById('action-params');
                const inputs = actionParamsDiv.querySelectorAll('input, select');

                inputs.forEach(input => {
                    if (input.value) {
                        params.set(input.name, input.value);
                    }
                });

                if (params.toString()) {
                    url += `?${params.toString()}`;
                }
            }

            document.getElementById('url-display').textContent = url;
            document.getElementById('generated-url').style.display = 'block';

            log(`üîó Generated URL: ${url}`);
        }

        function testURL() {
            const urlElement = document.getElementById('url-display');
            if (!urlElement.textContent) {
                generateURL();
            }

            const url = urlElement.textContent;
            if (url) {
                testProtocolURL(url, 'Custom Generated URL');
            }
        }

        function updateActionParams() {
            const action = document.getElementById('action').value;
            const paramsDiv = document.getElementById('action-params');

            paramsDiv.innerHTML = '';

            if (action === 'sync') {
                paramsDiv.innerHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <label>Direction:</label>
                            <select name="direction">
                                <option value="download">Download</option>
                                <option value="upload">Upload</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Local Path:</label>
                            <input type="text" name="localPath" placeholder="./local/path">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Options:</label>
                            <select name="mirror">
                                <option value="">Normal sync</option>
                                <option value="true">Mirror mode</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Verify:</label>
                            <select name="verify">
                                <option value="">No verification</option>
                                <option value="true">Verify checksums</option>
                            </select>
                        </div>
                    </div>
                `;
            } else if (action === 'terminal') {
                paramsDiv.innerHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <label>Command (optional):</label>
                            <input type="text" name="command" placeholder="ls -la">
                        </div>
                        <div class="form-group">
                            <label>Auto Execute:</label>
                            <select name="autoExecute">
                                <option value="">Manual</option>
                                <option value="true">Auto Execute</option>
                            </select>
                        </div>
                    </div>
                `;
            } else if (action === 'plugin') {
                paramsDiv.innerHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <label>Plugin Type:</label>
                            <select name="type">
                                <option value="terminal">Terminal</option>
                                <option value="browser">Browser</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Port:</label>
                            <input type="number" name="port" placeholder="8080">
                        </div>
                    </div>
                `;
            } else if (action === 'browser') {
                paramsDiv.innerHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <label>Path:</label>
                            <input type="text" name="path" placeholder="/" value="/">
                        </div>
                        <div class="form-group">
                            <label>View:</label>
                            <select name="view">
                                <option value="list">List View</option>
                                <option value="tree">Tree View</option>
                            </select>
                        </div>
                    </div>
                `;
            }
        }

        async function testAPIEndpoints() {
            const endpoints = [
                { name: 'Health Check', url: '/health' },
                { name: 'Credentials', url: '/api/credentials' },
                { name: 'Teams', url: '/api/teams' }
            ];

            let results = '<div style="margin-top: 10px;">';

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${CONFIG.apiBaseUrl.replace('/api', '')}${endpoint.url}`);
                    const status = response.ok ? '‚úÖ' : '‚ùå';
                    results += `<div>${status} ${endpoint.name}: ${response.status}</div>`;
                } catch (error) {
                    results += `<div>‚ùå ${endpoint.name}: Error</div>`;
                }
            }

            results += '</div>';
            document.getElementById('api-results').innerHTML = results;
        }

        function refreshData() {
            log('üîÑ Refreshing all data...');
            init();
        }

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connection-status');
            statusElement.className = `connection-status ${status}`;

            const indicator = status === 'connected' ? 'status-green' :
                            status === 'disconnected' ? 'status-red' : 'status-yellow';

            statusElement.innerHTML = `<span class="status-indicator ${indicator}"></span>${message}`;
        }

        function showServerStartInstructions() {
            document.getElementById('dynamic-test-links').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3>üöÄ Start the Protocol Test Server</h3>
                    <p>To use dynamic testing, please start the protocol test server:</p>
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">python3 tests/protocol/protocol_test_server.py</pre>
                    <p>Then refresh this page.</p>
                </div>
            `;
        }

        function copyURL() {
            const url = document.getElementById('url-display').textContent;
            navigator.clipboard.writeText(url).then(() => {
                log('üìã URL copied to clipboard');
            });
        }

        function openURL() {
            const url = document.getElementById('url-display').textContent;
            if (url) {
                log(`üöÄ Opening protocol URL: ${url}`);
                window.open(url, '_self');
            }
        }

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> ${message}`;

            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;

            console.log(`%cüîó Rediacc Protocol Testing`, 'color: #667eea; font-size: 16px; font-weight: bold;');
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('üóëÔ∏è Log cleared');
        }

        function exportResults() {
            const data = {
                timestamp: new Date().toISOString(),
                config: CONFIG,
                testResults: testResults,
                userAgent: navigator.userAgent
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `rediacc-protocol-test-results-${Date.now()}.json`;
            a.click();

            URL.revokeObjectURL(url);
            log('üíæ Test results exported');
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', init);

        // Refresh data periodically
        setInterval(() => {
            if (CONFIG.serverConnected) {
                testServerConnection();
            }
        }, 30000);
    </script>
</body>
</html>