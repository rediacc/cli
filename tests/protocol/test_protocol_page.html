<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rediacc Protocol Testing Page</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            margin: 20px 0;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .test-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .test-link {
            display: block;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            text-decoration: none;
            color: #495057;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .test-link:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .test-link .title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .test-link .url {
            font-family: 'Courier New', monospace;
            background: #f1f3f4;
            padding: 8px;
            border-radius: 3px;
            margin: 8px 0;
            word-break: break-all;
            font-size: 0.9em;
            border-left: 3px solid #667eea;
        }

        .test-link .description {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 8px;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .controls h3 {
            margin-top: 0;
            color: #495057;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
            margin: 5px;
        }

        .button:hover {
            background: #5a6fd8;
        }

        .button.secondary {
            background: #6c757d;
        }

        .button.secondary:hover {
            background: #5a6268;
        }

        .log {
            background: #212529;
            color: #ffffff;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid #495057;
        }

        .log-entry {
            margin: 3px 0;
            padding: 2px 0;
        }

        .log-entry.success { color: #28a745; }
        .log-entry.error { color: #dc3545; }
        .log-entry.info { color: #17a2b8; }
        .log-entry.warning { color: #ffc107; }

        .status-indicator {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-indicator.unknown { background: #ffc107; }
        .status-indicator.failed { background: #dc3545; }

        .copy-button {
            float: right;
            background: #17a2b8;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 10px;
        }

        .copy-button:hover {
            background: #138496;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .test-counter {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .test-links {
                grid-template-columns: 1fr;
            }

            .controls {
                padding: 15px;
            }

            .section {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîó Rediacc Protocol Testing Suite</h1>
        <p>Test rediacc:// protocol integration and browser communication</p>
        <div id="protocol-status" class="status-indicator unknown"></div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>üìã Quick Test Links</h2>
            <span class="test-counter" id="test-counter">12 Tests</span>
        </div>

        <div class="test-links" id="test-links">
            <!-- Test links will be populated by JavaScript -->
        </div>
    </div>

    <div class="section">
        <h2>üõ†Ô∏è Custom URL Generator</h2>
        <div class="controls">
            <div class="form-group">
                <label for="token">Token:</label>
                <input type="text" id="token" value="test-token-123456" placeholder="Authentication token">
            </div>

            <div class="form-group">
                <label for="team">Team:</label>
                <input type="text" id="team" value="TestTeam" placeholder="Team name">
            </div>

            <div class="form-group">
                <label for="machine">Machine:</label>
                <input type="text" id="machine" value="test-machine" placeholder="Machine name">
            </div>

            <div class="form-group">
                <label for="repository">Repository:</label>
                <input type="text" id="repository" value="test-repo" placeholder="Repository name">
            </div>

            <div class="form-group">
                <label for="action">Action:</label>
                <select id="action">
                    <option value="">None (basic connection)</option>
                    <option value="sync">sync</option>
                    <option value="terminal">terminal</option>
                    <option value="plugin">plugin</option>
                    <option value="browser">browser</option>
                </select>
            </div>

            <div class="form-group">
                <label for="custom-params">Custom Parameters (JSON):</label>
                <input type="text" id="custom-params" placeholder='{"direction":"upload","localPath":"C:\\test"}'>
            </div>

            <button class="button" onclick="generateCustomURL()">Generate & Test URL</button>
            <button class="button secondary" onclick="clearLog()">Clear Log</button>
            <button class="button secondary" onclick="exportTestResults()">Export Results</button>
        </div>
    </div>

    <div class="section">
        <h2>üìä Test Results & Log</h2>
        <div id="log" class="log">
            <div class="log-entry info">Protocol testing page loaded successfully</div>
            <div class="log-entry info">Ready to test rediacc:// protocol integration</div>
        </div>
    </div>

    <script>
        // Test configuration and state
        let testResults = [];
        let testStartTime = Date.now();

        // Predefined test scenarios
        const testScenarios = [
            {
                title: "Basic Connection Test",
                url: "rediacc://test-token/TestTeam/test-machine/test-repo",
                description: "Test basic protocol registration and connection"
            },
            {
                title: "Sync Upload Test",
                url: "rediacc://test-token/TestTeam/test-machine/test-repo/sync?direction=upload&localPath=C:\\TestUpload&mirror=true",
                description: "Test file upload synchronization with mirror mode"
            },
            {
                title: "Sync Download Test",
                url: "rediacc://test-token/TestTeam/test-machine/test-repo/sync?direction=download&localPath=C:\\TestDownload&verify=true",
                description: "Test file download synchronization with verification"
            },
            {
                title: "Repository Terminal",
                url: "rediacc://test-token/TestTeam/test-machine/test-repo/terminal",
                description: "Open terminal in repository environment"
            },
            {
                title: "Terminal with Command",
                url: "rediacc://test-token/TestTeam/test-machine/test-repo/terminal?command=ls%20-la&autoExecute=true",
                description: "Execute specific command in terminal"
            },
            {
                title: "Machine Terminal",
                url: "rediacc://test-token/TestTeam/test-machine/test-repo/terminal?terminalType=machine",
                description: "Open terminal directly on machine"
            },
            {
                title: "Jupyter Plugin",
                url: "rediacc://test-token/TestTeam/test-machine/test-repo/plugin?name=jupyter&port=8888&openBrowser=true",
                description: "Start Jupyter plugin with browser integration"
            },
            {
                title: "Custom Plugin",
                url: "rediacc://test-token/TestTeam/test-machine/test-repo/plugin?name=custom-app&port=3000&autoConnect=true",
                description: "Start custom plugin with auto-connection"
            },
            {
                title: "File Browser",
                url: "rediacc://test-token/TestTeam/test-machine/test-repo/browser?path=/var/log&view=list",
                description: "Browse files in specific directory"
            },
            {
                title: "File Browser with Filters",
                url: "rediacc://test-token/TestTeam/test-machine/test-repo/browser?path=/home&showHidden=true&sortBy=date",
                description: "Browse files with hidden files and date sorting"
            },
            {
                title: "Complex Parameters Test",
                url: "rediacc://test-token-with-dashes/Team%20With%20Spaces/machine-01/my-repo/sync?direction=upload&localPath=C:\\My%20Documents\\Project&mirror=true&preview=true",
                description: "Test URL encoding and complex parameter handling"
            },
            {
                title: "Security Test (Malformed)",
                url: "rediacc://../../malicious/path/../../../system/terminal?command=rm%20-rf%20/",
                description: "Test malformed URL handling and security boundaries"
            }
        ];

        // Initialize the page
        function initializePage() {
            populateTestLinks();
            checkProtocolStatus();
            setupEventListeners();
            log('Protocol testing page initialized', 'info');
        }

        // Populate test links dynamically
        function populateTestLinks() {
            const container = document.getElementById('test-links');
            container.innerHTML = '';

            testScenarios.forEach((scenario, index) => {
                const link = document.createElement('a');
                link.className = 'test-link';
                link.href = scenario.url;
                link.onclick = function(e) {
                    testProtocolURL(scenario.url, scenario.title, e);
                };

                link.innerHTML = `
                    <div class="title">${scenario.title}</div>
                    <div class="url">${scenario.url}</div>
                    <div class="description">${scenario.description}</div>
                    <button class="copy-button" onclick="copyToClipboard('${scenario.url}', event)">Copy</button>
                `;

                container.appendChild(link);
            });

            document.getElementById('test-counter').textContent = `${testScenarios.length} Tests`;
        }

        // Test a protocol URL
        function testProtocolURL(url, title, event) {
            if (event) {
                event.preventDefault();
            }

            const testStart = Date.now();
            log(`Testing: ${title}`, 'info');
            log(`URL: ${url}`, 'info');

            try {
                // Attempt to trigger protocol
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = url;
                document.body.appendChild(iframe);

                // Remove iframe after a short delay
                setTimeout(() => {
                    document.body.removeChild(iframe);
                }, 1000);

                // Record test attempt
                testResults.push({
                    title: title,
                    url: url,
                    timestamp: new Date().toISOString(),
                    duration: Date.now() - testStart,
                    status: 'attempted'
                });

                log(`Protocol test attempted successfully`, 'success');

                // Try to detect if protocol handler responded
                detectProtocolResponse(url, title);

            } catch (error) {
                log(`Error testing protocol: ${error.message}`, 'error');
                testResults.push({
                    title: title,
                    url: url,
                    timestamp: new Date().toISOString(),
                    duration: Date.now() - testStart,
                    status: 'error',
                    error: error.message
                });
            }
        }

        // Attempt to detect protocol response
        function detectProtocolResponse(url, title) {
            // This is limited by browser security, but we can try some detection methods
            const timeout = setTimeout(() => {
                log(`Protocol response timeout for: ${title}`, 'warning');
            }, 5000);

            // Try to detect focus changes (protocol handler might cause focus loss)
            const detectFocus = () => {
                clearTimeout(timeout);
                log(`Possible protocol handler activation detected`, 'info');
                document.removeEventListener('blur', detectFocus);
            };

            document.addEventListener('blur', detectFocus);

            // Also try to detect visibility changes
            const detectVisibility = () => {
                if (document.hidden) {
                    clearTimeout(timeout);
                    log(`Window became hidden - likely protocol handler activated`, 'success');
                    document.removeEventListener('visibilitychange', detectVisibility);
                }
            };

            document.addEventListener('visibilitychange', detectVisibility);
        }

        // Generate custom URL
        function generateCustomURL() {
            const token = document.getElementById('token').value || 'test-token';
            const team = document.getElementById('team').value || 'TestTeam';
            const machine = document.getElementById('machine').value || 'test-machine';
            const repository = document.getElementById('repository').value || 'test-repo';
            const action = document.getElementById('action').value;
            const customParams = document.getElementById('custom-params').value;

            let url = `rediacc://${token}/${team}/${machine}/${repository}`;

            if (action) {
                url += `/${action}`;
            }

            if (customParams) {
                try {
                    const params = JSON.parse(customParams);
                    const queryString = new URLSearchParams(params).toString();
                    if (queryString) {
                        url += `?${queryString}`;
                    }
                } catch (error) {
                    log(`Invalid JSON parameters: ${error.message}`, 'error');
                    return;
                }
            }

            log(`Generated custom URL: ${url}`, 'info');
            testProtocolURL(url, 'Custom Generated URL');
        }

        // Copy URL to clipboard
        function copyToClipboard(text, event) {
            event.stopPropagation();
            event.preventDefault();

            navigator.clipboard.writeText(text).then(() => {
                log(`Copied to clipboard: ${text}`, 'info');
            }).catch(err => {
                log(`Failed to copy: ${err.message}`, 'error');
            });
        }

        // Clear log
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }

        // Export test results
        function exportTestResults() {
            const results = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                testDuration: Date.now() - testStartTime,
                results: testResults,
                scenarios: testScenarios
            };

            const blob = new Blob([JSON.stringify(results, null, 2)], {
                type: 'application/json'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rediacc-protocol-test-results-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log('Test results exported', 'success');
        }

        // Check protocol registration status
        function checkProtocolStatus() {
            // This is limited by browser security, but we can try some basic checks
            const statusIndicator = document.getElementById('protocol-status');

            // Try to test if protocol is registered by attempting a basic URL
            const testUrl = 'rediacc://status-check/test/test/test';

            try {
                // Create a temporary iframe to test protocol
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = testUrl;
                document.body.appendChild(iframe);

                setTimeout(() => {
                    document.body.removeChild(iframe);
                    statusIndicator.className = 'status-indicator';
                    log('Protocol appears to be registered', 'success');
                }, 1000);

            } catch (error) {
                statusIndicator.className = 'status-indicator failed';
                log('Protocol registration check failed', 'warning');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Listen for keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 'r':
                            e.preventDefault();
                            location.reload();
                            break;
                        case 'c':
                            if (e.shiftKey) {
                                e.preventDefault();
                                clearLog();
                            }
                            break;
                        case 's':
                            if (e.shiftKey) {
                                e.preventDefault();
                                exportTestResults();
                            }
                            break;
                    }
                }
            });

            // Monitor focus and visibility for protocol detection
            window.addEventListener('focus', () => {
                log('Window regained focus', 'info');
            });

            window.addEventListener('blur', () => {
                log('Window lost focus', 'info');
            });
        }

        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', initializePage);

        // Add some helpful console logs for debugging
        console.log('%cüîó Rediacc Protocol Testing Page', 'color: #667eea; font-size: 16px; font-weight: bold;');
        console.log('This page can be used to test rediacc:// protocol integration');
        console.log('Check the browser console for additional debugging information');

        // Global test function for external scripts
        window.testRediaccProtocol = testProtocolURL;
        window.generateRediaccURL = generateCustomURL;
    </script>
</body>
</html>