#!/bin/bash
# Universal Rediacc CLI wrapper for Linux/macOS
# Provides similar functionality to the Windows PowerShell wrapper

set -e

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Helper functions
print_help() {
    echo -e "${CYAN}Rediacc CLI for Linux/macOS${NC}"
    echo
    echo "USAGE:"
    echo "    ./rediacc <command> [arguments]"
    echo
    echo "COMMANDS:"
    echo "    setup       Install dependencies and set up environment"
    echo "    test        Test installation and compatibility"
    echo "    login       Authenticate with Rediacc API"
    echo "    sync        File synchronization operations"
    echo "    term        Terminal access to repositories"
    echo "    help        Show this help message"
    echo
    echo "SETUP:"
    echo "    ./rediacc setup"
    echo "    ./rediacc setup --auto    # Auto-install without prompts"
    echo
    echo "AUTHENTICATION:"
    echo "    ./rediacc login --email user@example.com --password yourpass"
    echo "    ./rediacc login           # Interactive login"
    echo
    echo "SYNC OPERATIONS:"
    echo "    ./rediacc sync upload --token TOKEN --local /path --machine server --repo myrepo"
    echo "    ./rediacc sync download --token TOKEN --machine server --repo myrepo --local /path"
    echo "    ./rediacc sync --help"
    echo
    echo "TERMINAL ACCESS:"
    echo "    ./rediacc term --token TOKEN --machine server --repo myrepo"
    echo
    echo "For more information, see README.md"
}

# Get Python command
get_python_cmd() {
    if command -v python3 >/dev/null 2>&1; then
        echo "python3"
    elif command -v python >/dev/null 2>&1; then
        # Check if it's Python 3
        if python --version 2>&1 | grep -q "Python 3"; then
            echo "python"
        else
            echo ""
        fi
    else
        echo ""
    fi
}

# Main command handling
case "${1:-help}" in
    setup)
        shift
        "$SCRIPT_DIR/install.sh" "$@"
        ;;
        
    test)
        PYTHON_CMD=$(get_python_cmd)
        if [ -z "$PYTHON_CMD" ]; then
            echo -e "${RED}Error: Python 3 not found${NC}"
            echo "Run: ./rediacc setup"
            exit 1
        fi
        $PYTHON_CMD "$SCRIPT_DIR/test_windows_compat.py"
        ;;
        
    login)
        shift
        "$SCRIPT_DIR/rediacc-cli" login "$@"
        ;;
        
    sync)
        shift
        "$SCRIPT_DIR/rediacc-cli-sync" "$@"
        ;;
        
    term)
        shift
        "$SCRIPT_DIR/rediacc-cli-term" "$@"
        ;;
        
    help|--help|-h)
        print_help
        ;;
        
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo
        print_help
        exit 1
        ;;
esac